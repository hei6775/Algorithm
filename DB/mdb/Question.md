- 乐观锁和悲观锁

悲观锁

总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会阻塞直到它拿到锁（共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程）。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。

乐观锁

总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号机制和 CAS 算法实现。乐观锁适用于多读的应用类型，这样可以提高吞吐量，像数据库提供的类似于 write_condition 机制，其实都是提供的乐观锁。

- 什么是意向锁

MMAPV1 存储引擎锁的最小粒度为 Collection 级别，包括读锁（S）、写锁（X），并且还提供了意向读锁（IS）、意向写锁（IX），意向锁会加在比读写锁更高的粒度上，比如在 Collection 上加了读锁，相应的会在 db、Global 加意向读锁。

意向锁并不是真正的锁，只是表达了加锁的意向，所以意向锁之间是互相兼容的。X 锁和任何锁都是互斥的，包括 IX 锁，比如当前要更新 Collection 中的一个 document，使得该 Collection 被加了 X 锁，IX 锁会自动加载 Collection 所在 db、global 上，此时如果要在 db 级别做更新操作就需要在 db 上加 X 锁，由于 db 上已经有了 IX 锁，所以 db 级别的更新操作被阻塞。

意向锁的意义在于让更大级别的更新操作可以立即看到是否有小级别的更新操作在进行（如果没有意向锁，大更新操作要判断是否有小更新操作在进行，就需要遍历整个表），如果有，则大操作需要等待小操作释放锁（从而释放意向锁），如果没有，则可以放心的进行大操作。

- MongoDB 的事务功能

  4.0 版之前只支持单行或者单文档事务，4.0 版推出多文档事务，所以说它和 MYSQL 的数据库是不一样的。未来 4.2 版有可能推出 sharing 的多文档事务。

- MongoDB 的预分配模型

Power of 2 Sized Allocations：默认情况下，MMAPv1 中空间分配使用此策略，每个 document 的 size 是 2 的次幂，比如 32、64、128、256...2MB，如果文档尺寸大于 2MB，则空间为 2MB 的倍数（2M,4M,6M 等）。这种策略有 2 种优势，首先那些删除或者 update 变大而产生的磁盘碎片空间（尺寸变大，意味着开辟新空间存储此 document，旧的空间被 mark 为 deleted）可以被其他 insert 重用，再者 padding 可以允许文档尺寸有限度的增长，而无需每次 update 变大都重新分配空间。此外，mongodb 还提供了一个可选的“No padding Allocation”策略（即按照实际数据尺寸分配空间），如果你确信数据绝大多数情况下都是 insert、in-place update，极少的 delete，此策略将可以有效的节约磁盘空间，看起来数据更加紧凑，磁盘利用率也更高。
